name: Build and Save
concurrency:
  group: "build"
  cancel-in-progress: false
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'
      - name: Permission setup
        run: chmod +x ./gradlew
      - name: build
        run: ./gradlew build
      - name: Rename artifacts
        run: |
          cd build/libs
          for file in *.jar; do
            if [ -f "$file" ]; then
              # Extract base name and extension
              if [[ "$file" =~ ^(.*)-dev\.jar$ ]]; then
                # Handle -dev.jar files
                base="${BASH_REMATCH[1]}"
                newname="${base}-#${{ github.run_number }}-dev.jar"
              elif [[ "$file" =~ ^(.*)\.jar$ ]]; then
                # Handle regular .jar files (not -dev)
                base="${BASH_REMATCH[1]}"
                newname="${base}-#${{ github.run_number }}.jar"
              else
                continue
              fi
              mv "$file" "$newname"
              echo "Renamed: $file -> $newname"
            fi
          done
      - name: Get artifact names
        id: get_names
        run: |
          cd build/libs
          MAIN_JAR=$(ls Sakura-*-#${{ github.run_number }}.jar | head -n 1)
          ALL_JAR=$(ls Sakura-*-#${{ github.run_number }}-dev.jar | head -n 1)
          echo "main_name=${MAIN_JAR%.jar}" >> $GITHUB_OUTPUT
          echo "all_name=${ALL_JAR%.jar}" >> $GITHUB_OUTPUT
      - name: Upload main JAR
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get_names.outputs.main_name }}
          path: build/libs/Sakura-*-#${{ github.run_number }}.jar
          retention-days: 30
          compression-level: 0
      - name: Upload all JAR
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get_names.outputs.all_name }}
          path: build/libs/Sakura-*-#${{ github.run_number }}-dev.jar
          retention-days: 15
          compression-level: 0
